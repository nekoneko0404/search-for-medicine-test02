# 薬局ヒヤリ・ハット事例ビューア - 仕様書

## 1. アプリケーション名
薬局ヒヤリ・ハット事例ビューア

## 2. 概要
本Webアプリケーションは、日本医療機能評価機構が提供する「薬局ヒヤリ・ハット事例収集等事業」のAPIを利用し、薬局におけるヒヤリ・ハット事例を検索・閲覧するためのシングルページアプリケーションです。ユーザーは医薬品名や成分名、または事例内容や背景・要因に関するキーワードで事例を検索し、改善策の有無や発生年月日でソートされた結果を閲覧できます。

## 3. 機能一覧

### 3.1. 事例表示
*   デフォルトでは、最新のヒヤリ・ハット事例が最大50件表示されます。
*   検索キーワード（医薬品名/成分名）または絞り込みキーワード（事例内容/背景・要因）が指定された場合、関連する事例が表示されます。
*   表示される事例は、改善策があるものを優先し、その中で新しいものから順にソートされます。
*   各事例カードには、発生年月、事例の概要、事例の詳細、背景・要因、改善策が表示されます。

### 3.2. 検索機能
*   **検索キーワード (医薬品名/成分名):**
    *   入力フィールドに医薬品名または成分名を入力し、「検索」ボタンをクリックするかEnterキーを押すことで、該当する事例を検索します。
    *   URLパラメータ `ingredientName` または `drugName` に対応します。
*   **絞り込みキーワード (事例内容/背景・要因):**
    *   入力フィールドにキーワードを入力し、「絞り込み」ボタンをクリックするかEnterキーを押すことで、現在の検索結果に対して事例内容または背景・要因で絞り込みを行います。
    *   URLパラメータ `word` に対応します。
*   **検索結果の連動:**
    *   検索キーワードと絞り込みキーワードは同時に適用され、検索キーワードで取得した結果に対して絞り込みキーワードでフィルタリングが行われます。

### 3.3. UI操作
*   検索キーワード入力フィールドと絞り込みキーワード入力フィールドは横並びで表示されます。
*   各入力フィールドでEnterキーを押すことで、それぞれの検索/絞り込みが実行されます。
*   「クリア」ボタンは削除されました。

## 4. 技術スタック
*   **フロントエンド:** HTML, CSS, JavaScript
*   **API連携:** `fetch` API, DOMParser (XMLパース)

## 5. API連携
*   **APIエンドポイント:** `https://hiyari-proxy-708146219355.asia-east1.run.app/proxy` (Cloud Runプロキシ経由)
*   **参照API仕様書:** [`https://www.yakkyoku-hiyari.jcqhc.or.jp/pdf/text_api_specification_v2.pdf`](https://www.yakkyoku-hiyari.jcqhc.or.jp/pdf/text_api_specification_v2.pdf)
*   **リクエストパラメータ:**
    *   `count=50`: 取得件数を50件に設定。
    *   `order=2`: 新しいもの順にソート。
    *   `item=DATMEDNAME` & `word=[キーワード]`: 医薬品名/成分名で検索。
    *   `word=[キーワード]` (itemなし): 事例内容または背景・要因でクライアント側フィルタリング。
    *   `condition=any`: 部分一致検索。
*   **レスポンス形式:** XML
*   **エラーハンドリング:** APIからのエラーレスポンスやHTTPエラーが発生した場合、ユーザーにエラーメッセージを表示します。

## 6. UI/UXの変更点
*   **レイアウト:** 検索キーワードと絞り込みキーワードの入力欄が横並びになりました。
*   **デザイン・配色:** 添付画像を参考に、全体的に落ち着いた色合い（ウォームグレーを基調とした配色）に変更されました。
    *   背景色: `#f0f2f5`
    *   ヘッダー背景: `#e0e6ed`
    *   ヘッダーテキスト: `#34495e`
    *   プライマリテキスト: `#34495e`
    *   セカンダリテキスト: `#5c6f82`
    *   アクセント/ボタン背景: `#6c757d`
    *   ボタンホバー: `#5a6268`
    *   カード背景: `#ffffff`
    *   ボーダー: `#d1d9e6`
    *   シャドウ: `rgba(0, 0, 0, 0.08)`
*   **ソート順:** 改善策がある事例が優先され、その中で新しいものから表示されます。

## 7. 今後の課題
*   APIが `word` パラメータのみで複数の `item` を暗黙的に検索しない場合、クライアント側でのフィルタリングが必須となります。大量のデータを取得してクライアント側でフィルタリングする場合、パフォーマンスの最適化が必要になる可能性があります。
*   検索キーワードと絞り込みキーワードの組み合わせ検索において、API側でより柔軟な検索オプションが提供されれば、クライアント側のロジックを簡素化できます。