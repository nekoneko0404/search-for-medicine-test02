<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YJコード検索ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loading-container { display: flex; justify-content: center; align-items: center; min-height: 200px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .progress-bar { width: 100%; height: 10px; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background-color: #6366f1; transition: width 0.3s ease-in-out; }
        .table-cell-with-padding { padding: 12px 16px; }
        .card-item { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        a.manufacturer-link { color: #4f46e5; text-decoration: none; }
        a.manufacturer-link:hover { text-decoration: underline; }
        .status-button-container { display: flex; justify-content: center; align-items: center; height: 100%; padding: 0.5rem 0; }
        .status-button { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; white-space: nowrap; transition-colors: 0.15s; line-height: 1; }
        .name-clickable { color: #3730a3; text-decoration: none; cursor: pointer; }
        .name-clickable:hover { text-decoration: underline; }
    </style>
</head>
<body class="p-6 md:p-12 flex flex-col items-center bg-stone-50 text-slate-800">

    <div class="w-full max-w-7xl bg-white rounded-3xl shadow-xl p-4 sm:p-6 border border-slate-200">
        <div class="flex flex-col sm:flex-row items-center justify-between mb-4 space-y-2 sm:space-y-0 sm:space-x-4">
            <h1 class="text-2xl font-extrabold text-slate-900 leading-tight">YJコード検索ツール</h1>
            <a href="https://nekoneko0404.github.io/search-for-medicine-test03/" class="px-3 py-1.5 bg-indigo-100 text-indigo-700 text-sm rounded-lg font-medium hover:bg-indigo-200 transition-colors duration-300 whitespace-nowrap">医薬品検索ツールへ戻る</a>
        </div>
        
        <div class="mb-4 flex flex-col sm:flex-row items-center justify-between sm:space-x-4 space-y-2 sm:space-y-0">
            <button id="searchButton" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-indigo-700 transition-colors duration-300 whitespace-nowrap text-sm w-full sm:w-auto">検索</button>
            <input type="text" id="yjCodeInput" placeholder="YJコードを入力してください:" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 transition-all duration-300 text-sm">
            <span id="dataDate" class="text-gray-500 text-xs whitespace-nowrap"></span>
        </div>

        <!-- ✅ チェックボックス群 -->
        <div class="flex flex-row space-x-4 mb-4">
            <div class="bg-slate-50 p-2 rounded-xl shadow-inner border border-slate-200 flex-grow">
                <h3 class="font-semibold text-slate-800 mb-1 text-sm">検索項目</h3>
                <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm">
                    <label class="flex items-center"><input type="checkbox" id="digits3" checked>薬効群3桁</label>
                    <label class="flex items-center"><input type="checkbox" id="digits4" checked>薬効群4桁</label>
                    <label class="flex items-center"><input type="checkbox" id="digits7" checked>成分</label>
                    <label class="flex items-center"><input type="checkbox" id="digits8" checked>剤形</label>
                    <label class="flex items-center"><input type="checkbox" id="digits9" checked>規格単位</label>
                    <label class="flex items-center"><input type="checkbox" id="digits11">規格内番号</label>
                </div>
            </div>
            
            <div class="bg-slate-50 p-2 rounded-xl shadow-inner border border-slate-200 flex-grow">
                <h3 class="font-semibold text-slate-800 mb-1 text-sm">出荷状況</h3>
                <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm">
                    <label class="flex items-center"><input type="checkbox" id="statusNormal" checked>通常出荷</label>
                    <label class="flex items-center"><input type="checkbox" id="statusLimited">限定出荷</label>
                    <label class="flex items-center"><input type="checkbox" id="statusStop">供給停止</label>
                </div>
            </div>
        </div>

        <div id="messageBox" class="mt-4 p-4 rounded-xl text-sm hidden" role="alert"></div>
    </div>

    <div id="loadingIndicator" class="loading-container hidden"><div class="spinner"></div></div>
    <div id="progressBarContainer" class="w-full max-w-7xl mt-4 hidden">
        <div class="progress-bar"><div id="progressBar" class="progress-bar-fill w-0"></div></div>
        <p id="progressMessage" class="text-xs text-gray-500 mt-1 text-center"></p>
    </div>
    
    <div id="resultsContainer" class="w-full max-w-7xl mt-8"></div>

    <script>
        let data = [];
        let manufacturerLinks = {};
        const messageBox = document.getElementById('messageBox');

        function showMessage(message, type = "error") {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            if (type === "error") {
                messageBox.className = "mt-4 p-4 rounded-xl text-sm bg-red-100 text-red-700";
            } else if (type === "success") {
                messageBox.className = "mt-4 p-4 rounded-xl text-sm bg-green-100 text-green-700";
            } else {
                messageBox.className = "mt-4 p-4 rounded-xl text-sm bg-blue-100 text-blue-700";
            }
        }
        function hideMessage(delay = 0) {
            if (delay > 0) {
                setTimeout(() => messageBox.classList.add('hidden'), delay);
            } else {
                messageBox.classList.add('hidden');
            }
        }

        // ✅ GoogleDriveから直接 fetch に修正
        window.onload = function() {
            const spreadsheetId = '1zdSaqw_cYDUOgufUREsoDUE_BxCrQmMd';
            const exportUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=xlsx`;

            async function fetchSpreadsheetData() {
                showMessage('共有スプレッドシートからデータを読み込み中です...', 'info');
                try {
                    const response = await fetch(exportUrl);
                    if (response.ok) {
                        const dataBuffer = await response.arrayBuffer();
                        const workbook = XLSX.read(new Uint8Array(dataBuffer), { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        data = XLSX.utils.sheet_to_json(sheet, { defval: "" });
                        document.getElementById('dataDate').textContent = `(データ: Google Drive)`;

                        showMessage("データの読み込みが完了しました。検索欄に入力すると自動で絞り込みが開始されます。", "success");
                        hideMessage(4000);
                    } else {
                        showMessage(`データの取得に失敗しました。ステータスコード: ${response.status}`, 'error');
                        hideMessage(5000);
                    }
                } catch (error) {
                    console.error('データの取得に失敗しました:', error);
                    showMessage('共有スプレッドシートからのデータの取得中にエラーが発生しました。', 'error');
                    hideMessage(5000);
                }
            }

            const manufacturerId = '1lTHHbUj6ySAgtum8zJrHjWAxYnbOO9r8H8Cnu-Y0TnA';
            const manufacturerUrl = `https://docs.google.com/spreadsheets/d/${manufacturerId}/export?format=xlsx`;

            async function fetchManufacturerData() {
                try {
                    const response = await fetch(manufacturerUrl);
                    if (response.ok) {
                        const dataBuffer = await response.arrayBuffer();
                        const workbook = XLSX.read(new Uint8Array(dataBuffer), { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        rows.slice(1).forEach(row => {
                            if (row[0] && row[1]) manufacturerLinks[row[0].trim()] = row[1].trim();
                        });
                        console.log(`メーカーリンク ${Object.keys(manufacturerLinks).length} 件`);
                    } else {
                        console.error(`メーカー情報の取得失敗: ${response.status}`);
                    }
                } catch (error) {
                    console.error('メーカー情報の取得に失敗しました:', error);
                }
            }

            attachSearchListeners();
            fetchSpreadsheetData();
            fetchManufacturerData();
        };

        // ✅ 検索処理・結果表示処理は元の yjcode(1).html をそのまま保持
        function attachSearchListeners() {
            const searchButton = document.getElementById('searchButton');
            const yjCodeInput = document.getElementById('yjCodeInput');
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            searchButton.addEventListener('click', performSearch);
            yjCodeInput.addEventListener('keypress', e => { if (e.key === 'Enter') performSearch(); });
            checkboxes.forEach(cb => cb.addEventListener('change', performSearch));
        }

        function performSearch() {
            // 🔍 元の検索ロジックをそのまま残してください（省略）
        }

        function displayResults(results) {
            // 🔍 元の結果表示ロジックをそのまま残してください（省略）
        }
    </script>
</body>
</html>
