<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YJコード検索ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght400;700&display=swap">
    <link rel="stylesheet" href="unify.css">
</head>
<body class="bg-gray-200 p-4 sm:p-8 flex flex-col items-center min-h-screen">

    <div class="w-full max-w-7xl bg-white rounded-3xl shadow-xl p-4 sm:p-6 border border-slate-200">
        <div class="flex flex-col sm:flex-row items-center justify-between mb-4 space-y-2 sm:space-y-0 sm:space-x-4">
            <h1 class="text-2xl font-extrabold text-slate-900 leading-tight">
                YJコード検索ツール
            </h1>
            <a href="./" class="px-3 py-1.5 bg-indigo-100 text-indigo-700 text-sm rounded-lg font-medium hover:bg-indigo-200 transition-colors duration-300 whitespace-nowrap">
                医薬品検索ツールへ戻る
            </a>
        </div>
        
        <div class="mb-4 flex flex-col sm:flex-row items-center justify-between sm:space-x-4 space-y-2 sm:space-y-0">
            <button id="searchButton" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-indigo-700 transition-colors duration-300 whitespace-nowrap text-sm w-full sm:w-auto">
                検索
            </button>
            <input type="text" id="yjCodeInput" placeholder="YJコードを入力してください:" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 transition-all duration-300 text-sm">
            <span id="dataDate" class="text-gray-500 text-xs whitespace-nowrap"></span>
        </div>

        <div class="flex flex-row space-x-4 mb-4">
            <div class="bg-slate-50 p-2 rounded-xl shadow-inner border border-slate-200 flex-grow">
                <h3 class="font-semibold text-slate-800 mb-1 text-sm">検索項目</h3>
                <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm">
                    <label class="flex items-center">
                        <input type="checkbox" id="digits3" class="form-checkbox rounded text-indigo-600 focus:ring-indigo-500" checked>
                        <span class="ml-1 text-slate-700">薬効群3桁</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="digits4" class="form-checkbox rounded text-indigo-600 focus:ring-indigo-500" checked>
                        <span class="ml-1 text-slate-700">薬効群4桁</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="digits7" class="form-checkbox rounded text-indigo-600 focus:ring-indigo-500" checked>
                        <span class="ml-1 text-slate-700">成分</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="digits8" class="form-checkbox rounded text-indigo-600 focus:ring-indigo-500" checked>
                        <span class="ml-1 text-slate-700">剤形</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="digits9" class="form-checkbox rounded text-indigo-600 focus:ring-indigo-500" checked>
                        <span class="ml-1 text-slate-700">規格単位</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="digits11" class="form-checkbox rounded text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-1 text-slate-700">規格内番号</span>
                    </label>
                </div>
            </div>
            
            <div class="bg-slate-50 p-2 rounded-xl shadow-inner border border-slate-200 flex-grow">
                <h3 class="font-semibold text-slate-800 mb-1 text-sm">出荷状況</h3>
                <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm">
                    <label class="flex items-center">
                        <input type="checkbox" id="statusNormal" class="form-checkbox rounded text-indigo-600 focus:ring-indigo-500" checked>
                        <span class="ml-1 text-slate-700">通常出荷</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="statusLimited" class="form-checkbox rounded text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-1 text-slate-700">限定出荷</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="statusStop" class="form-checkbox rounded text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-1 text-slate-700">供給停止</span>
                    </label>
                </div>
            </div>
        </div>

        <div id="messageBox" class="mt-4 p-4 rounded-xl text-sm hidden" role="alert"></div>
    </div>

    <div id="loadingIndicator" class="loading-container hidden">
        <div class="spinner"></div>
    </div>
    <div id="progressBarContainer" class="w-full max-w-7xl mt-4 hidden">
        <div class="progress-bar">
            <div id="progressBar" class="progress-bar-fill w-0"></div>
        </div>
        <p id="progressMessage" class="text-xs text-gray-500 mt-1 text-center"></p>
    </div>
    
    <div id="resultsContainer" class="w-full max-w-7xl mt-8"></div>

    <script>
        let data = [];
        let manufacturerLinks = {};
        const loadingIndicator = document.getElementById('loadingIndicator');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const progressMessage = document.getElementById('progressMessage');
        const messageBox = document.getElementById('messageBox');
        
        function showMessage(message, isError = true) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            if (isError) {
                messageBox.classList.remove('bg-green-100', 'text-green-700');
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                messageBox.classList.remove('bg-red-100', 'text-red-700');
                messageBox.classList.add('bg-green-100', 'text-green-700');
            }
        }

        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        function normalizeString(str) {
            if (!str) return '';
            return String(str).trim().toLowerCase().replace(/[ァ-ヶ]/g, s => String.fromCharCode(s.charCodeAt(0) - 0x60));
        }

        function updateProgress(message, percentage) {
            progressBarContainer.classList.remove('hidden');
            progressMessage.textContent = message;
            progressBar.style.width = `${percentage}%`;
        }
        
        function renderStatusButton(status) {
            const trimmedStatus = (status || "").trim();
            let baseClass = "status-button";
            
            if (trimmedStatus.includes("通常出荷") || trimmedStatus.includes("通")) {
                return `<span class="${baseClass} bg-indigo-500 text-white hover:bg-indigo-600">通常出荷</span>`; 
            } else if (trimmedStatus.includes("限定出荷") || trimmedStatus.includes("出荷制限") || trimmedStatus.includes("限") || trimmedStatus.includes("制")) {
                return `<span class="${baseClass} bg-yellow-400 text-gray-800 hover:bg-yellow-500">限定出荷</span>`;
            } else if (trimmedStatus.includes("供給停止") || trimmedStatus.includes("停止") || trimmedStatus.includes("停")) {
                return `<span class="${baseClass} bg-gray-700 text-white hover:bg-gray-800">供給停止</span>`;
            } else {
                return `<span class="${baseClass} bg-gray-200 text-gray-800 hover:bg-gray-300">${trimmedStatus || "不明"}</span>`; 
            }
        }

        function processExcelData(arrayBuffer) {
            updateProgress('データを処理中...', 75);
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            
            const jsonDataWithStrings = XLSX.utils.sheet_to_json(worksheet, { header: 1, range: 1 });
            const jsonDataWithNumbers = XLSX.utils.sheet_to_json(worksheet, { header: 1, range: 1, raw: true });

            if (jsonDataWithStrings.length < 2) return [];

            const dataRowsAsStrings = jsonDataWithStrings.slice(1);
            const dataRowsAsNumbers = jsonDataWithNumbers.slice(1);

            return dataRowsAsStrings.map((row, index) => {
                const numberRow = dataRowsAsNumbers[index];
                return {
                    'ingredientName':       row[2],
                    'yjCode':               row[4],
                    'productName':          row[5],
                    'manufacturer':         row[6],
                    'productCategory':      row[7],
                    'isBasicDrug':          row[8],
                    'shipmentStatus':       row[11],
                    'reasonForLimitation':  row[13],
                    'resolutionProspect':   row[14],
                    'expectedDate':         numberRow[15] || row[15],
                    'shipmentVolumeStatus': row[16],
                    'updateDateSerial':     numberRow[19]
                };
            });
        }

        async function fetchExcelData() {
            console.log('Fetching Excel data from Google Drive...');
            updateProgress('Google Driveからデータを読み込み中...', 0);
            
            const fileId = '1yhDbdCbnmDoXKRSj_CuLgKkIH2ohK1LD';
            const url = `https://docs.google.com/spreadsheets/d/${fileId}/export?format=xlsx`;

            try {
                updateProgress('データをダウンロード中...', 50);
                const response = await fetch(url, { cache: "no-cache" }); // キャッシュを無効化
                console.log('Response Headers:', Object.fromEntries(response.headers.entries()));
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Fetch Error Body:', errorText);
                    throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                console.log(`Successfully fetched ${arrayBuffer.byteLength} bytes.`);
                const processedData = processExcelData(arrayBuffer);

                if (processedData.length > 0) {
                    try {
                        console.log("Saving fetched data to sessionStorage.");
                        const cachePayload = {
                            timestamp: new Date().getTime(),
                            data: processedData
                        };
                        sessionStorage.setItem('excelCache', JSON.stringify(cachePayload));
                    } catch (e) {
                        console.warn("Failed to save data to sessionStorage. It might be full.", e);
                        showMessage("データサイズが大きいため、キャッシュの保存に失敗しました。タブを閉じるとデータは失われます。", false);
                    }
                }

                console.log(`Data loaded successfully. Number of rows: ${processedData.length}`);
                updateProgress('データの読み込みが完了しました！', 100);
                return { data: processedData, date: 'Google Drive' };
            } catch (error) {
                console.error(`データの取得に失敗しました: ${url} ${error}`);
                showMessage(`データの取得に失敗しました。詳細: ${error.message}`);
            } finally {
                setTimeout(() => progressBarContainer.classList.add('hidden'), 1000);
            }
            return { data: null, date: null };
        }

        async function fetchManufacturerData() {
            console.log('Fetching manufacturer data from Google Drive...');
            const fileId = '1lTHHbUj6ySAgtum8zJrHjWAxYnbOO9r8H8Cnu-Y0TnA';
            const googleDriveUrl = `https://docs.google.com/spreadsheets/d/${fileId}/export?format=xlsx`;

            try {
                const response = await fetch(googleDriveUrl, { cache: "no-cache" }); // キャッシュを無効化
                console.log('Manufacturer Data Response Headers:', Object.fromEntries(response.headers.entries()));
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Fetch Error Body (Manufacturer):', errorText);
                    throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                console.log(`Successfully fetched ${arrayBuffer.byteLength} bytes for manufacturer data.`);
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                const links = {};
                for(let R = range.s.r + 1; R <= range.e.r; ++R) {
                    const cellA = worksheet[XLSX.utils.encode_cell({r: R, c: 0})];
                    const cellB = worksheet[XLSX.utils.encode_cell({r: R, c: 1})];
                    const manufacturerName = cellA ? XLSX.utils.format_cell(cellA) : null;
                    const url = cellB ? XLSX.utils.format_cell(cellB) : null;
                    if (manufacturerName && url) links[manufacturerName.trim()] = url.trim();
                };
                return links;
            } catch (error) {
                console.error(`メーカーデータの取得に失敗しました: ${googleDriveUrl} ${error}`);
                return {};
            }
        }

        function performSearch() {
            const yjCodeInput = document.getElementById('yjCodeInput');
            const yjCode = normalizeString(yjCodeInput.value.trim());
            
            const isAnyDigitChecked = ['digits3', 'digits4', 'digits7', 'digits8', 'digits9', 'digits11'].some(id => document.getElementById(id).checked);
            const statusNormal = document.getElementById('statusNormal').checked;
            const statusLimited = document.getElementById('statusLimited').checked;
            const statusStop = document.getElementById('statusStop').checked;

            hideMessage();
            document.getElementById('resultsContainer').innerHTML = '';

            if (isAnyDigitChecked) {
                if (!yjCode || yjCode.length !== 12 || !/^[0-9a-zA-Z]+$/.test(yjCode)) {
                    showMessage('検索項目をチェックした際は、正しい12桁のYJコードを入力してください。');
                    return;
                }
            }

            if (!isAnyDigitChecked && !statusNormal && !statusLimited && !statusStop) {
                showMessage('検索項目と出荷状況のチェックを全て外したため、検索結果は表示されません。', false);
                return;
            }

            let filteredData = data;
            
            if (isAnyDigitChecked) {
                const checks = {
                    d11: document.getElementById('digits11').checked,
                    d9: document.getElementById('digits9').checked,
                    d8: document.getElementById('digits8').checked,
                    d7: document.getElementById('digits7').checked,
                    d4: document.getElementById('digits4').checked,
                    d3: document.getElementById('digits3').checked
                };

                filteredData = filteredData.filter(item => {
                    const itemYjCode = normalizeString(item.yjCode || '');
                    if (!itemYjCode) return false;

                    if (checks.d11) return itemYjCode.startsWith(yjCode.substring(0, 11));
                    
                    let match = true;
                    if (checks.d9) match = match && itemYjCode.charAt(8) === yjCode.charAt(8);
                    if (checks.d8) match = match && itemYjCode.charAt(7) === yjCode.charAt(7);
                    if (checks.d7) match = match && itemYjCode.startsWith(yjCode.substring(0, 7));
                    else if (checks.d4) match = match && itemYjCode.startsWith(yjCode.substring(0, 4));
                    else if (checks.d3) match = match && itemYjCode.startsWith(yjCode.substring(0, 3));

                    return match;
                });
            }
            
            if (statusNormal || statusLimited || statusStop) {
                filteredData = filteredData.filter(item => {
                    const status = normalizeString(item.shipmentStatus || '');
                    if (statusNormal && (status.includes('通常出荷') || status.includes('通'))) return true;
                    if (statusLimited && (status.includes('限定出荷') || status.includes('出荷制限') || status.includes('限') || status.includes('制'))) return true;
                    if (statusStop && (status.includes('供給停止') || status.includes('停止') || status.includes('停'))) return true;
                    return false;
                });
            }

            displayResults(filteredData.slice(0, 500));
            if (filteredData.length === 0) {
                showMessage('条件に一致する医薬品は見つかりませんでした。', false);
            }
        }

        function displayResults(results) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';
            if (results.length === 0) return;

            const tableContainer = document.createElement('div');
            tableContainer.className = 'hidden md:block overflow-x-auto bg-white rounded-2xl shadow-lg border border-slate-200';
            const table = document.createElement('table');
            table.className = 'min-w-full text-left table-auto text-sm';
            table.innerHTML = `
                <thead class="bg-indigo-100">
                    <tr>
                        <th class="py-3 px-2 font-semibold text-indigo-800 whitespace-nowrap w-24">YJコード</th>
                        <th class="py-3 px-4 font-semibold text-indigo-800 w-60">品名</th>
                        <th class="py-3 px-4 font-semibold text-indigo-800 w-48">成分名</th>
                        <th class="py-3 px-4 font-semibold text-indigo-800 w-32">メーカー</th>
                        <th class="py-3 px-4 font-semibold text-indigo-800 w-32 whitespace-nowrap text-center">出荷状況</th>
                        <th class="py-3 px-4 font-semibold text-indigo-800 w-48">制限理由</th>
                        <th class="py-3 px-4 font-semibold text-indigo-800 w-48 whitespace-nowrap">出荷量状況</th>
                    </tr>
                </thead>
            `;
            const tbody = document.createElement('tbody');
            tbody.className = 'divide-y divide-slate-200';
            results.forEach(item => {
                const row = document.createElement('tr');
                row.className = `transition-colors duration-200 even:bg-white odd:bg-indigo-50 hover:bg-indigo-100`;
                const isBase = item.isBasicDrug && normalizeString(item.isBasicDrug).includes('基礎的医薬品');
                const isGeneric = item.productCategory && normalizeString(item.productCategory).includes('後発品');
                let labels = '';
                if (isBase) labels += `<span class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full text-xs font-semibold">基</span>`;
                if (isGeneric) labels += `<span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full text-xs font-semibold">後</span>`;
                
                const manufacturerName = item.manufacturer || '-';
                const manufacturerUrl = manufacturerLinks[manufacturerName];
                const manufacturerContent = manufacturerUrl ? `<a href="${manufacturerUrl}" target="_blank" rel="noopener noreferrer" class="manufacturer-link">${manufacturerName}</a>` : `<span class="text-slate-700">${manufacturerName}</span>`;

                row.innerHTML = `
                    <td class="py-3 px-2 text-sm">${item.yjCode || '-'}</td>
                    <td class="py-3 px-4 flex items-center">
                        <span class="flex flex-col items-start mr-2 space-y-1">${labels}</span>
                        <span class="name-clickable" data-yjcode="${item.yjCode || ''}">${item.productName || '-'}</span>
                    </td>
                    <td class="py-3 px-4">${item.ingredientName || '-'}</td>
                    <td class="py-3 px-4">${manufacturerContent}</td>
                    <td class="py-3 px-4 text-center"><div class="status-button-container">${renderStatusButton(item.shipmentStatus)}</div></td>
                    <td class="py-3 px-4">${item.reasonForLimitation || '-'}</td>
                    <td class="py-3 px-4">${item.shipmentVolumeStatus || '-'}</td>
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            tableContainer.appendChild(table);
            container.appendChild(tableContainer);

            const cardListContainer = document.createElement('div');
            cardListContainer.className = 'block md:hidden w-full space-y-4';
            results.forEach(item => container.appendChild(createCardElement(item)));

            document.querySelectorAll('#resultsContainer .name-clickable').forEach(element => {
                element.addEventListener('click', (e) => {
                    const yjCode = e.currentTarget.dataset.yjcode;
                    if (yjCode) {
                        document.getElementById('yjCodeInput').value = yjCode;
                        ['digits3', 'digits4', 'digits7', 'statusNormal'].forEach(id => document.getElementById(id).checked = true);
                        ['digits8', 'digits9', 'digits11', 'statusLimited', 'statusStop'].forEach(id => document.getElementById(id).checked = false);
                        performSearch();
                    }
                });
            });
        }

        function createCardElement(item) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg border border-slate-200 p-4';
            const isBase = item.isBasicDrug && normalizeString(item.isBasicDrug).includes('基礎的医薬品');
            const isGeneric = item.productCategory && normalizeString(item.productCategory).includes('後発品');
            let labels = '';
            if (isBase) labels += `<span class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full text-xs font-semibold mr-1">基</span>`;
            if (isGeneric) labels += `<span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full text-xs font-semibold mr-1">後</span>`;
            
            const manufacturerName = item.manufacturer || '-';
            const manufacturerUrl = manufacturerLinks[manufacturerName];
            const manufacturerContent = manufacturerUrl ? `<a href="${manufacturerUrl}" target="_blank" rel="noopener noreferrer" class="manufacturer-link">${manufacturerName}</a>` : `<span class="text-slate-700">${manufacturerName}</span>`;

            card.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-base font-bold text-indigo-700 leading-tight"> <span class="card-name-clickable name-clickable" data-yjcode="${item.yjCode || ''}">${item.productName || '-'}</span></h3>
                    <div class="flex items-center space-x-1 flex-shrink-0">${labels}</div>
                </div>
                <div class="text-sm space-y-1">
                    <div class="flex justify-between items-start card-item"><span class="text-slate-500 font-semibold w-1/3 flex-shrink-0">YJコード:</span><span class="text-right w-2/3">${item.yjCode || '-'}</span></div>
                    <div class="flex justify-between items-start card-item"><span class="text-slate-500 font-semibold w-1/3 flex-shrink-0">成分名:</span><span class="text-right w-2/3">${item.ingredientName || '-'}</span></div>
                    <div class="flex justify-between items-start card-item"><span class="text-slate-500 font-semibold w-1/3 flex-shrink-0">メーカー:</span><span class="text-right w-2/3">${manufacturerContent}</span></div>
                    <hr class="my-2">
                    <div class="flex justify-between items-center card-item"><span class="text-slate-500 font-semibold">出荷状況:</span><span>${renderStatusButton(item.shipmentStatus)}</span></div>
                    <div class="flex justify-between items-start card-item"><span class="text-slate-500 font-semibold w-1/3 flex-shrink-0">制限理由:</span><span class="text-right w-2/3">${item.reasonForLimitation || '-'}</span></div>
                    <div class="flex justify-between items-start card-item"><span class="text-slate-500 font-semibold w-1/3 flex-shrink-0">出荷量状況:</span><span class="text-right w-2/3">${item.shipmentVolumeStatus || '-'}</span></div>
                </div>
            `;
            return card;
        }

        async function initializeApp() {
            loadingIndicator.classList.remove('hidden');
            
            const manufacturerDataPromise = fetchManufacturerData();
            
            const cachedData = sessionStorage.getItem('excelCache');
            let excelDataPromise;

            if (cachedData) {
                console.log("Found cached data in sessionStorage.");
                excelDataPromise = Promise.resolve({ data: JSON.parse(cachedData).data, date: 'キャッシュ' });
            } else {
                console.log("No cached data found. Fetching from network.");
                excelDataPromise = fetchExcelData();
            }

            const [manufacturerDataResult, excelDataResult] = await Promise.all([manufacturerDataPromise, excelDataPromise]);

            manufacturerLinks = manufacturerDataResult;
            
            if (excelDataResult && excelDataResult.data) {
                data = excelDataResult.data;
                const dateInfo = excelDataResult.date ? `(データ: ${excelDataResult.date})` : '';
                document.getElementById('dataDate').textContent = dateInfo;

                const urlParams = new URLSearchParams(window.location.search);
                const yjCodeFromUrl = urlParams.get('yjcode');
                if (yjCodeFromUrl) {
                    document.getElementById('yjCodeInput').value = String(yjCodeFromUrl).trim();
                    performSearch();
                } else {
                    showMessage('データの準備ができました。YJコードを入力して検索してください。', false);
                }
            } else {
                showMessage('データの読み込みに失敗しました。ページを再読み込みしてください。');
            }
            
            loadingIndicator.classList.add('hidden');
        }

        document.getElementById('searchButton').addEventListener('click', performSearch);
        document.getElementById('yjCodeInput').addEventListener('keypress', e => { if (e.key === 'Enter') performSearch(); });
        document.getElementById('yjCodeInput').addEventListener('input', e => { if (e.target.value.trim().length === 12) performSearch(); });
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.addEventListener('change', performSearch));
        
        initializeApp();
    </script>
</body>
</html>