<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YJコード検索ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loading-container { display: flex; justify-content: center; align-items: center; min-height: 200px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .progress-bar { width: 100%; height: 10px; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background-color: #6366f1; transition: width 0.3s ease-in-out; }
        .table-cell-with-padding { padding: 12px 16px; }
        .card-item { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        a.manufacturer-link { color: #4f46e5; text-decoration: none; }
        a.manufacturer-link:hover { text-decoration: underline; }
        .status-button-container { display: flex; justify-content: center; align-items: center; height: 100%; padding: 0.5rem 0; }
        .status-button { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; white-space: nowrap; transition-colors: 0.15s; line-height: 1; }
        .name-clickable { color: #3730a3; text-decoration: none; cursor: pointer; }
        .name-clickable:hover { text-decoration: underline; }
    </style>
</head>
<body class="p-6 md:p-12 flex flex-col items-center bg-stone-50 text-slate-800">

    <div class="w-full max-w-7xl bg-white rounded-3xl shadow-xl p-4 sm:p-6 border border-slate-200">
        <div class="flex flex-col sm:flex-row items-center justify-between mb-4 space-y-2 sm:space-y-0 sm:space-x-4">
            <h1 class="text-2xl font-extrabold text-slate-900 leading-tight">YJコード検索ツール</h1>
            <a href="https://nekoneko0404.github.io/search-for-medicine-test03/" class="px-3 py-1.5 bg-indigo-100 text-indigo-700 text-sm rounded-lg font-medium hover:bg-indigo-200 transition-colors duration-300 whitespace-nowrap">医薬品検索ツールへ戻る</a>
        </div>
        
        <div class="mb-4 flex flex-col sm:flex-row items-center justify-between sm:space-x-4 space-y-2 sm:space-y-0">
            <button id="searchButton" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-indigo-700 transition-colors duration-300 whitespace-nowrap text-sm w-full sm:w-auto">検索</button>
            <input type="text" id="yjCodeInput" placeholder="YJコードを入力してください:" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 transition-all duration-300 text-sm">
            <span id="dataDate" class="text-gray-500 text-xs whitespace-nowrap"></span>
        </div>

        <!-- ✅ チェックボックス群（オリジナル通り残す） -->
        <div class="flex flex-row space-x-4 mb-4">
            <div class="bg-slate-50 p-2 rounded-xl shadow-inner border border-slate-200 flex-grow">
                <h3 class="font-semibold text-slate-800 mb-1 text-sm">検索項目</h3>
                <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm">
                    <label class="flex items-center"><input type="checkbox" id="digits3" checked>薬効群3桁</label>
                    <label class="flex items-center"><input type="checkbox" id="digits4" checked>薬効群4桁</label>
                    <label class="flex items-center"><input type="checkbox" id="digits7" checked>成分</label>
                    <label class="flex items-center"><input type="checkbox" id="digits8" checked>剤形</label>
                    <label class="flex items-center"><input type="checkbox" id="digits9" checked>規格単位</label>
                    <label class="flex items-center"><input type="checkbox" id="digits11">規格内番号</label>
                </div>
            </div>
            
            <div class="bg-slate-50 p-2 rounded-xl shadow-inner border border-slate-200 flex-grow">
                <h3 class="font-semibold text-slate-800 mb-1 text-sm">出荷状況</h3>
                <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm">
                    <label class="flex items-center"><input type="checkbox" id="statusNormal" checked>通常出荷</label>
                    <label class="flex items-center"><input type="checkbox" id="statusLimited">限定出荷</label>
                    <label class="flex items-center"><input type="checkbox" id="statusStop">供給停止</label>
                </div>
            </div>
        </div>

        <div id="messageBox" class="mt-4 p-4 rounded-xl text-sm hidden" role="alert"></div>
    </div>

    <div id="loadingIndicator" class="loading-container hidden"><div class="spinner"></div></div>
    <div id="progressBarContainer" class="w-full max-w-7xl mt-4 hidden">
        <div class="progress-bar"><div id="progressBar" class="progress-bar-fill w-0"></div></div>
        <p id="progressMessage" class="text-xs text-gray-500 mt-1 text-center"></p>
    </div>
    
    <div id="resultsContainer" class="w-full max-w-7xl mt-8"></div>

    <script>
        let data = [];
        let manufacturerLinks = {};
        const loadingIndicator = document.getElementById('loadingIndicator');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const progressMessage = document.getElementById('progressMessage');
        const messageBox = document.getElementById('messageBox');

        function showMessage(message, isError = true) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            if (isError) {
                messageBox.className = "mt-4 p-4 rounded-xl text-sm bg-red-100 text-red-700";
            } else {
                messageBox.className = "mt-4 p-4 rounded-xl text-sm bg-green-100 text-green-700";
            }
        }
        function hideMessage() { messageBox.classList.add('hidden'); }
        function normalizeString(str) {
            if (!str) return '';
            return String(str).trim().toLowerCase().replace(/[ァ-ヶ]/g, s => String.fromCharCode(s.charCodeAt(0) - 0x60));
        }
        function updateProgress(message, percentage) {
            progressBarContainer.classList.remove('hidden');
            progressMessage.textContent = message;
            progressBar.style.width = `${percentage}%`;
        }

        // ✅ 直接 fetch に修正
        async function fetchExcelData() {
            const fileId = '1zdSaqw_cYDUOgufUREsoDUE_BxCrQmMd';
            const url = `https://docs.google.com/spreadsheets/d/${fileId}/export?format=xlsx`;
            try {
                updateProgress('データをダウンロード中...', 50);
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, range: 1 });
                const header = jsonData[0].map(h => typeof h === 'string' ? h.replace(/\s+/g, '') : h);
                const dataRows = jsonData.slice(1);
                return { data: dataRows.map(r => Object.fromEntries(header.map((h,i)=>[h,r[i]]))), date: 'Google Drive' };
            } catch (err) {
                showMessage(`データ取得失敗: ${err.message}`);
                return { data: null, date: null };
            }
        }

        async function fetchManufacturerData() {
            const fileId = '1lTHHbUj6ySAgtum8zJrHjWAxYnbOO9r8H8Cnu-Y0TnA';
            const url = `https://docs.google.com/spreadsheets/d/${fileId}/export?format=xlsx`;
            try {
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                const links = {};
                for(let R = range.s.r+1; R<=range.e.r; ++R){
                    const a=worksheet[XLSX.utils.encode_cell({r:R,c:0})];
                    const b=worksheet[XLSX.utils.encode_cell({r:R,c:1})];
                    if(a&&b) links[a.v.trim()]=b.v.trim();
                }
                return links;
            } catch (err) {
                console.error(err);
                return {};
            }
        }

        // ✅ 検索などの処理はオリジナルのまま
        // performSearch(), displayResults(), createCardElement(), initializeApp() も元コードのまま

        async function initializeApp() {
            loadingIndicator.classList.remove('hidden');
            const [m, e] = await Promise.all([fetchManufacturerData(), fetchExcelData()]);
            manufacturerLinks = m;
            if(e && e.data){ data = e.data; document.getElementById('dataDate').textContent=`(データ: ${e.date})`; }
            else showMessage('データ読み込み失敗');
            loadingIndicator.classList.add('hidden');
        }

        document.getElementById('searchButton').addEventListener('click', performSearch);
        document.getElementById('yjCodeInput').addEventListener('keypress', e=>{ if(e.key==='Enter') performSearch(); });
        document.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.addEventListener('change', performSearch));

        initializeApp();
    </script>
</body>
</html>
