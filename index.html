<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>医薬品 出荷状況検索ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght400;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .message-box-center {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            white-space: pre-wrap; /* 複数行のメッセージに対応 */
        }
        /* 1画面の情報量を多くするための調整 */
        .table-container {
            max-height: 70vh; /* 画面の約70%を最大高さとする */
            overflow-y: auto;
        }
        /* PC画面向けレイアウト */
        .search-form-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4つの列を均等に設定 */
            gap: 1.5rem; /* 隙間 */
            align-items: end; /* 縦方向の配置を下に揃える */
        }
        /* 出荷状況のセルスタイル (左揃えを維持) */
        .tight-cell {
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
            line-height: 1.2;
            font-size: 0.75rem; /* text-xs相当 */
        }

        /* 品名ラベルの縦並びとスペース調整用のスタイル */
        .vertical-labels-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 0.25rem;
            gap: 1px;
        }
        
        /* 【修正済み】出荷状況チェックボックスの表示制御 */
        .status-checkbox-group {
            display: flex; 
            flex-wrap: wrap; /* 狭い画面では折り返す */
            gap: 0.5rem; /* チェックボックス間の隙間 */
            width: 100%;
        }
        
        /* 狭い画面（デフォルト）での2段組みレイアウト */
        .status-checkbox-group .checkbox-item {
            /* 100% / 2 - gap/2 で計算。padding/marginを考慮して48%程度に設定 */
            width: calc(50% - 0.25rem); /* 2つ並んで折り返すように調整 */
            flex-shrink: 0;
            white-space: nowrap;
        }
        
        /* 広い画面 (768px以上) では1行に3つ横並びを強制 */
        @media (min-width: 768px) {
            .status-checkbox-group {
                flex-wrap: nowrap; /* 強制的に折り返しを禁止 */
                justify-content: space-between; /* 均等な間隔で配置 */
                gap: 0.75rem; /* 広い画面での隙間 */
            }
            .status-checkbox-group .checkbox-item {
                 /* 広い画面では幅を固定せずにflex-shrink: 0で制御 */
                width: auto;
                margin-right: 0.5rem; 
            }
            .status-checkbox-group .checkbox-item:last-child {
                margin-right: 0; 
            }
        }

        /* 狭い画面向けレイアウト（mdサイズ以下）の修正 */
        @media (max-width: 767px) {
            .search-form-grid {
                grid-template-columns: repeat(2, 1fr); /* 2つの列に分割 */
                gap: 1rem; /* 隙間を狭くする */
            }
            .search-form-grid .full-width-on-mobile {
                grid-column: span 2; /* 狭い画面では2列にまたがる */
            }
            /* チェックボックスコンテナを狭い画面では2列目に配置（flex-startに調整）*/
            .search-form-grid .status-checkbox-container {
                grid-column: 2 / span 1; /* 2列目の位置に配置 */
                justify-self: start; /* 左寄せ */
            }
        }
        
        /* スマートフォン向けにテーブルのレイアウトを調整 (変更なし) */
        @media (max-width: 640px) {
            .table-container table {
                table-layout: fixed;
                width: 100%;
            }
            .table-container th, .table-container td {
                word-wrap: break-word;
                white-space: normal;
                padding: 0.5rem;
            }
            .table-container thead {
                display: none; /* スマホではヘッダーを非表示 */
            }
            .table-container tbody, .table-container tr {
                display: block; /* tbodyとtrをブロック要素にして積み重ねる */
            }
            .table-container tr {
                margin-bottom: 1rem;
                padding: 0.5rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
            }
            .table-container td {
                display: flex; /* Flexboxを使って項目と内容を横並びに */
                align-items: flex-start;
                width: 100%;
                border-bottom: none;
                padding: 0.25rem 0.5rem;
            }
            .table-container td:before {
                content: attr(data-label);
                font-weight: 600;
                color: #4b5563;
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                flex-shrink: 0; /* ラベルが縮まないように固定 */
                width: 80px; /* ラベルの幅を確保 */
                margin-right: 0.5rem; /* ラベルと内容の間にスペースを追加 */
            }
            .truncate-lines {
                display: -webkit-box;
                -webkit-line-clamp: 2; /* 2行に制限 */
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
            /* スマートフォンで非表示にする項目 (変更なし) */
            td[data-label='成分名'],
            td[data-label='出荷量状況'] {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-200 p-4 sm:p-8 flex flex-col items-center min-h-screen">
    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg w-full max-w-7xl relative">
        <div class="flex justify-between items-center mb-6">
            <div class="flex-grow flex justify-center">
                <div class="bg-indigo-100 rounded-lg py-2 px-4 mb-4 text-center inline-block">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">
                        <span class="hidden sm:inline">医薬品 出荷状況検索ツール</span>
                        <span class="sm:hidden">医薬品 出荷状況</span>
                    </h2>
                </div>
            </div>
            <a href="https://nekoneko0404.github.io/search-for-medicine-test03/readme.html" target="_blank" class="bg-indigo-500 text-white hover:bg-indigo-600 transition duration-150 ease-in-out py-1 px-3 rounded-md shadow-sm font-medium whitespace-nowrap">
                使い方
            </a>
        </div>
        
        <div id="messageBox" class="text-sm sm:text-base text-center p-3 rounded-lg hidden message-box-center w-3/4"></div>
        
        <div class="search-form-grid mb-6">
            <div class="input-container">
                <label for="drugName" class="block text-gray-700 text-sm font-medium mb-1">医薬品名:</label>
                <input type="text" id="drugName" placeholder="例: ロキソニン" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition ease-in-out duration-150 p-2">
            </div>
            <div class="input-container">
                <label for="ingredientName" class="block text-gray-700 text-sm font-medium mb-1">成分名:</label>
                <input type="text" id="ingredientName" placeholder="例: ロキソプロフェン" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition ease-in-out duration-150 p-2">
            </div>
            <div class="input-container">
                <label for="makerName" class="block text-gray-700 text-sm font-medium mb-1">規格、剤形、ﾒｰｶｰ:</label>
                <input type="text" id="makerName" placeholder="例: 60mg" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition ease-in-out duration-150 p-2">
            </div>
            
            <div class="status-checkbox-container flex flex-col justify-between">
                <div class="block text-gray-700 text-sm font-medium mb-1">出荷状況:</div>
                <div class="status-checkbox-group pb-2">
                    <div class="checkbox-item flex items-center">
                        <input type="checkbox" id="statusNormal" value="通常出荷" checked class="form-checkbox h-4 w-4 text-indigo-600 transition duration-150 ease-in-out">
                        <label for="statusNormal" class="ml-1 text-xs text-gray-900">通常出荷</label>
                    </div>
                    <div class="checkbox-item flex items-center">
                        <input type="checkbox" id="statusLimited" value="限定出荷" checked class="form-checkbox h-4 w-4 text-indigo-600 transition duration-150 ease-in-out">
                        <label for="statusLimited" class="ml-1 text-xs text-gray-900">出荷制限</label>
                    </div>
                    <div class="checkbox-item flex items-center">
                        <input type="checkbox" id="statusStopped" value="供給停止" checked class="form-checkbox h-4 w-4 text-indigo-600 transition duration-150 ease-in-out">
                        <label for="statusStopped" class="ml-1 text-xs text-gray-900">供給停止</label>
                    </div>
                </div>
            </div>
            
        </div>
        
        <div id="tableContainer" class="table-container rounded-lg shadow-md border border-gray-200 hidden">
            <table id="resultTable" class="min-w-full divide-y divide-gray-200 table-fixed">
                <thead class="bg-indigo-100 sticky top-0">
                    <tr>
                        <th class="px-2 py-2 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap lg:w-[28%]">品名</th>
                        <th class="px-2 py-2 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap lg:w-[28%]">成分名</th>
                        <th class="px-1 py-2 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap lg:w-[15%]">
                            <div class="flex items-center justify-start"> <span class="whitespace-nowrap">出荷状況</span>
                                <button onclick="sortResults('status')" class="ml-1 text-indigo-600 hover:text-indigo-800 transition-colors duration-150">
                                    <span id="sort-status-icon">▲</span>
                                </button>
                            </div>
                        </th>
                        <th class="px-2 py-2 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap lg:w-[18%]">制限理由</th>
                        <th class="px-2 py-2 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap lg:w-[11%]">出荷量状況</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="resultTableBody">
                    </tbody>
            </table>
        </div>
        
        <div class="mt-8 text-center text-gray-500 text-sm">
            <p>ご意見・ご要望は製作者までお寄せください。</p>
            <p>ツイッター: <a href="https://x.com/oshigoto_twitte" target="_blank" class="text-indigo-500 hover:underline">@oshigoto_twitte</a></p>
        </div>
    </div>

    <script>
        let excelData = [];
        let filteredResults = [];
        let sortStates = {
            status: 'asc'
        };
        const messageBox = document.getElementById('messageBox');
        const tableContainer = document.getElementById('tableContainer');
        let isComposing = false;
        
        function showMessage(text, type = 'info') {
            messageBox.textContent = text;
            messageBox.classList.remove('hidden', 'bg-red-200', 'text-red-800', 'bg-green-200', 'text-green-800', 'bg-blue-200', 'text-blue-800');
            messageBox.classList.add('block');
            if (type === 'error') {
                messageBox.classList.add('bg-red-200', 'text-red-800');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-200', 'text-green-800');
            } else {
                messageBox.classList.add('bg-blue-200', 'text-blue-800');
            }
        }
        function hideMessage(delay) {
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, delay);
        }
        function normalizeString(str) {
            if (!str) return '';
            const hiraToKata = str.replace(/[\u3041-\u3096]/g, function(match) {
                const charCode = match.charCodeAt(0) + 0x60;
                return String.fromCharCode(charCode);
            });
            const normalizedStr = hiraToKata.normalize('NFKC');
            return normalizedStr.toLowerCase();
        }
        function getSearchKeywords(input) {
            return input.split(/\s+|　+/).filter(keyword => keyword !== '').map(keyword => normalizeString(keyword));
        }
        function processExcelData(data) {
            try {
                const workbook = XLSX.read(data, {type: 'array'});
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                excelData = XLSX.utils.sheet_to_json(sheet, {header:1});
                showMessage("データの読み込みが完了しました。", "success");
                hideMessage(3000);
            } catch (error) {
                console.error('Error processing data:', error);
                showMessage("データの処理中にエラーが発生しました。", "error");
                hideMessage(3000);
            }
        }

        /**
         * @param {string} status 出荷状況の文字列 (例: '限定出荷')
         * @returns {string} Tailwind CSSで装飾された<span>タグのHTML文字列
         */
        function renderStatusButton(status) {
            const trimmedStatus = (status || "").trim();
            // インラインブロック要素にすることで、リンクがボタン全体を覆うようにする
            let baseClass = "px-3 py-1 rounded-full text-xs font-semibold whitespace-nowrap inline-block transition-colors duration-150";
            
            if (trimmedStatus.includes("通常出荷") || trimmedStatus.includes("通")) {
                return `<span class="${baseClass} bg-indigo-500 text-white hover:bg-indigo-600">通常出荷</span>`; 
            } else if (trimmedStatus.includes("限定出荷") || trimmedStatus.includes("出荷制限") || trimmedStatus.includes("限") || trimmedStatus.includes("制")) {
                return `<span class="${baseClass} bg-yellow-400 text-gray-800 hover:bg-yellow-500">出荷制限</span>`; // ✅ 変更
            } else if (trimmedStatus.includes("供給停止") || trimmedStatus.includes("停止") || trimmedStatus.includes("停")) {
                return `<span class="${baseClass} bg-gray-700 text-white hover:bg-gray-800">供給停止</span>`; // ✅ 変更
            } else {
                // その他の場合は元の文字列、または不明なステータスとして表示
                return `<span class="${baseClass} bg-gray-200 text-gray-800 hover:bg-gray-300">${trimmedStatus || "不明"}</span>`; 
            }
        }


        function searchData() {
            if (excelData.length === 0) {
                return;
            }

            const drugKeywords = getSearchKeywords(document.getElementById('drugName').value);
            const ingredientKeywords = getSearchKeywords(document.getElementById('ingredientName').value);
            const makerKeywords = getSearchKeywords(document.getElementById('makerName').value);
            
            const allCheckboxesChecked = document.getElementById('statusNormal').checked && document.getElementById('statusLimited').checked && document.getElementById('statusStopped').checked;
            const allSearchFieldsEmpty = drugKeywords.length === 0 && ingredientKeywords.length === 0 && makerKeywords.length === 0;

            if (allSearchFieldsEmpty && allCheckboxesChecked) {
                renderTable([]);
                tableContainer.classList.add('hidden');
                hideMessage(0);
                return;
            } else {
                tableContainer.classList.remove('hidden');
            }
            
            const statusFilters = [];
            if (document.getElementById('statusNormal').checked) {
                statusFilters.push("通常出荷");
            }
            if (document.getElementById('statusLimited').checked) {
                statusFilters.push("出荷制限"); 
                statusFilters.push("限定出荷"); 
            }
            if (document.getElementById('statusStopped').checked) {
                statusFilters.push("供給停止");
            }

            filteredResults = [];
            for (let i = 1; i < excelData.length; i++) {
                const row = excelData[i];
                if (!row || row.length < 17) continue;

                const drugName = normalizeString(row[5] || "");
                const ingredientName = normalizeString(row[2] || "");
                const makerName = normalizeString((row[6] || "") + (row[9] || ""));
                const currentStatus = (row[11] || '').trim(); 

                const matchDrug = drugKeywords.every(keyword => drugName.includes(keyword));
                const matchIngredient = ingredientKeywords.every(keyword => ingredientName.includes(keyword));
                const matchMaker = makerKeywords.every(keyword => drugName.includes(keyword) || makerName.includes(keyword));
                
                let matchStatus = false;
                let statusText = '';
                if (currentStatus.includes('通常') || currentStatus.includes('通')) {
                    statusText = '通常出荷';
                } else if (currentStatus.includes('限定') || currentStatus.includes('限') || currentStatus.includes('制限') || currentStatus.includes('制')) { 
                    statusText = '出荷制限';
                    if (currentStatus.includes('限定')) statusText = '限定出荷'; 
                } else if (currentStatus.includes('停止') || currentStatus.includes('停')) {
                    statusText = '供給停止';
                }
                
                if (statusFilters.includes(statusText)) {
                    matchStatus = true;
                }
                
                if (matchDrug && matchIngredient && matchMaker && matchStatus) {
                    filteredResults.push(row);
                }
            }
            
            renderTable(filteredResults);
            
            if (filteredResults.length === 0) {
                 showMessage("検索結果が見つかりませんでした。", "info");
                 hideMessage(3000);
            } else if (filteredResults.length > 500) {
                 showMessage(`${filteredResults.length} 件のデータが見つかりました。\n表示は上位 500 件に制限されています。`, "success");
                 hideMessage(3000);
            } else {
                 showMessage(`${filteredResults.length} 件のデータが見つかりました。`, "success");
                 hideMessage(3000);
            }

            sortStates.status = 'asc';
            document.getElementById('sort-status-icon').textContent = '▲';
        }
        
        // handleIngredientClick関数は変更なし
        function handleIngredientClick(ingredient) {
            document.getElementById('drugName').value = '';
            document.getElementById('makerName').value = '';
            const searchIngredient = ingredient.length > 5 ? ingredient.substring(0, 5) : ingredient;
            document.getElementById('ingredientName').value = searchIngredient;
            searchData();
            showMessage(`「${searchIngredient}」で再検索を実行しました。`, 'info');
            hideMessage(3000);
        }


        // テーブルのレンダリング関数を修正
        function renderTable(data) {
            const resultBody = document.getElementById('resultTableBody');
            resultBody.innerHTML = "";
            const statusIndex = 11; // L列のインデックス

            if (data.length === 0) {
                const row = resultBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 5;
                cell.textContent = "該当データがありません";
                cell.className = "px-4 py-3 text-sm text-gray-500 text-center italic";
                return;
            }

            const displayResults = data.slice(0, 500);
            displayResults.forEach((row, index) => {
                const newRow = resultBody.insertRow();
                const rowBgClass = index % 2 === 1 ? 'bg-indigo-50' : 'bg-white';
                newRow.className = `${rowBgClass} transition-colors duration-150 hover:bg-indigo-200`;

                // 品名 (F列): text-sm
                const drugNameCell = newRow.insertCell(0);
                drugNameCell.setAttribute('data-label', '品名');
                drugNameCell.classList.add("px-2", "py-2", "text-sm", "text-gray-900");
                
                let labelsHtml = '';
                const hColumnValue = (row[7] || '').trim(); // H列: 後発品・長期収載品
                const iColumnValue = (row[8] || '').trim(); // I列: 基礎的医薬品

                const labels = [];
                if (hColumnValue === '後発品') {
                    labels.push(`<span class="bg-green-200 text-green-800 px-1 rounded-sm text-xs font-bold whitespace-nowrap">後</span>`);
                }
                if (iColumnValue === '基礎的医薬品') {
                    labels.push(`<span class="bg-purple-200 text-purple-800 px-1 rounded-sm text-xs font-bold whitespace-nowrap">基</span>`);
                }
                
                if (labels.length > 0) {
                    labelsHtml = `<div class="vertical-labels-container">${labels.join('')}</div>`;
                }

                const drugName = row[5]; // F列
                const yjCode = row[4]; // E列
                const pmdaLinkUrl = `https://www.pmda.go.jp/PmdaSearch/rdSearch/02/${yjCode}?user=1`;
                
                drugNameCell.innerHTML = `<div class="flex items-start">${labelsHtml}<a href="${pmdaLinkUrl}" target="_blank" class="text-indigo-600 font-semibold hover:underline truncate-lines">${drugName || ""}</a></div>`;
                
                // 成分名 (C列): text-sm
                const ingredientNameCell = newRow.insertCell(1);
                ingredientNameCell.setAttribute('data-label', '成分名');
                ingredientNameCell.classList.add("px-2", "py-2", "text-sm", "text-gray-900", "truncate-lines");
                const ingredientName = row[2] || "";
                
                if (ingredientName) {
                    ingredientNameCell.innerHTML = `<a href="#" onclick="handleIngredientClick('${ingredientName.replace(/'/g, "\\'")}')" class="text-indigo-600 font-semibold hover:underline">${ingredientName}</a>`;
                } else {
                    ingredientNameCell.textContent = ingredientName;
                }
                
                // ✅ 変更: 出荷状況 (L列): renderStatusButtonの結果をリンクで囲む
                const statusCell = newRow.insertCell(2);
                statusCell.setAttribute('data-label', '出荷状況');
                // tight-cellはpaddingの調整に使用
                statusCell.classList.add("tight-cell", "py-2", "text-gray-900", "text-left"); 
                
                const statusValue = (row[statusIndex] || '').trim();
                const statusButtonHtml = renderStatusButton(statusValue);
                
                if (yjCode) {
                    // YJコードへのリンクURLを設定
                    const yjCodeLinkUrl = `https://nekoneko0404.github.io/search-for-medicine-test03/yjcode.html?yjcode=${yjCode}`;
                    
                    // ボタンHTML全体をハイパーリンクで囲む
                    // `flex justify-center`を追加して、ボタンをセル内で中央揃えにする
                    statusCell.innerHTML = `<div class="flex justify-center"><a href="${yjCodeLinkUrl}" target="_blank" class="block text-indigo-600 hover:no-underline">${statusButtonHtml}</a></div>`;
                } else {
                    // YJコードがない場合はボタンのみ表示 (中央揃え)
                    statusCell.innerHTML = `<div class="flex justify-center">${statusButtonHtml}</div>`;
                }
                
                // 制限理由 (N列): text-xs
                const reasonCell = newRow.insertCell(3);
                reasonCell.textContent = row[13] || "";
                reasonCell.setAttribute('data-label', '制限理由');
                reasonCell.classList.add("px-2", "py-2", "text-xs", "text-gray-900", "truncate-lines");

                // 出荷量状況 (Q列): text-xs
                const volumeCell = newRow.insertCell(4);
                volumeCell.textContent = row[16] || "";
                volumeCell.setAttribute('data-label', '出荷量状況');
                volumeCell.classList.add("px-2", "py-2", "text-xs", "text-gray-900");
            });
        }
        
        // ソート関数、イベントリスナー、window.onload は変更なし
        function sortResults(key) {
            if (filteredResults.length === 0) {
                showMessage("ソートするデータがありません。", "info");
                hideMessage(3000);
                return;
            }
            const newDirection = sortStates[key] === 'asc' ? 'desc' : 'asc';
            sortStates[key] = newDirection;
            document.getElementById(`sort-${key}-icon`).textContent = newDirection === 'asc' ? '▲' : '▼';
            filteredResults.sort((a, b) => {
                const aValue = (a[11] || '').trim();
                const bValue = (b[11] || '').trim();
                const compare = aValue.localeCompare(bValue, 'ja', { sensitivity: 'base' });
                return newDirection === 'asc' ? compare : -compare;
            });
            renderTable(filteredResults);
            showMessage(`「出荷状況」を${newDirection === 'asc' ? '昇順' : '降順'}でソートしました。`, "success");
            hideMessage(3000);
        }
        
        function formatDate(date) {
            const year = date.getFullYear().toString().slice(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function attachSearchListeners() {
            const inputIds = ['drugName', 'ingredientName', 'makerName'];

            inputIds.forEach(id => {
                const element = document.getElementById(id);
                
                element.addEventListener('compositionstart', () => {
                    isComposing = true;
                });

                element.addEventListener('compositionend', () => {
                    isComposing = false;
                    searchData(); 
                });

                element.addEventListener('input', () => {
                    if (!isComposing) {
                        searchData();
                    }
                });
            });

            document.getElementById('statusNormal').addEventListener('change', searchData);
            document.getElementById('statusLimited').addEventListener('change', searchData);
            document.getElementById('statusStopped').addEventListener('change', searchData);
        }

        window.onload = function() {
            const spreadsheetId = '1zdSaqw_cYDUOgufUREsoDUE_BxCrQmMd';
            const exportUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=xlsx`;

            async function fetchSpreadsheetData() {
                showMessage('共有スプレッドシートからデータを読み込み中です...', 'info');
                
                try {
                    const response = await fetch(exportUrl);
                    if (response.ok) {
                        const data = await response.arrayBuffer();
                        processExcelData(new Uint8Array(data));
                        renderTable([]);
                        tableContainer.classList.add('hidden'); 
                        showMessage("データの読み込みが完了しました。検索欄に入力すると自動で絞り込みが開始されます。", "success");
                        hideMessage(4000);
                    } else {
                        showMessage(`データの取得に失敗しました。ステータスコード: ${response.status}`, 'error');
                        hideMessage(5000);
                    }
                } catch (error) {
                    console.error('データの取得に失敗しました:', error);
                    showMessage('共有スプレッドシートからのデータの取得中にエラーが発生しました。', 'error');
                    hideMessage(5000);
                }
            }
            
            attachSearchListeners();
            fetchSpreadsheetData();
        };
    </script>
</body>
</html>
