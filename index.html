<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>医薬品 出荷状況検索ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .message-box-center {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            white-space: pre-wrap; /* 複数行のメッセージに対応 */
        }
        .table-container {
            max-height: 60vh; /* 画面の60%を最大高さとする */
            overflow-y: auto;
        }
        /* PC画面向けレイアウト */
        .search-form-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4つの列を均等に設定 */
            gap: 1.5rem; /* 隙間 */
            align-items: end; /* 縦方向の配置を下に揃える */
        }
        /* 狭い画面向けレイアウト（mdサイズ以下） */
        @media (max-width: 767px) {
            .search-form-grid {
                grid-template-columns: repeat(2, 1fr); /* 2つの列に分割 */
                gap: 1rem; /* 隙間を狭くする */
            }
            .search-form-grid .full-width-on-mobile {
                grid-column: span 2; /* 狭い画面では2列にまたがる */
            }
            .search-form-grid .search-button-container {
                grid-column: 2 / span 1; /* 検索ボタンを2列目の位置に配置 */
                justify-self: end; /* 右寄せ */
            }
        }
        /* スマートフォン向けにテーブルのレイアウトを調整 */
        @media (max-width: 640px) {
            .table-container table {
                table-layout: fixed;
                width: 100%;
            }
            .table-container th, .table-container td {
                word-wrap: break-word;
                white-space: normal;
                padding: 0.5rem;
            }
            .table-container thead {
                display: none; /* スマホではヘッダーを非表示 */
            }
            .table-container tbody, .table-container tr {
                display: block; /* tbodyとtrをブロック要素にして積み重ねる */
            }
            .table-container tr {
                margin-bottom: 1rem;
                padding: 0.5rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
            }
            .table-container td {
                display: flex; /* Flexboxを使って項目と内容を横並びに */
                align-items: flex-start;
                width: 100%;
                border-bottom: none;
                padding: 0.25rem 0.5rem;
            }
            .table-container td:before {
                content: attr(data-label);
                font-weight: 600;
                color: #4b5563;
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                flex-shrink: 0; /* ラベルが縮まないように固定 */
                width: 80px; /* ラベルの幅を確保 */
                margin-right: 0.5rem; /* ラベルと内容の間にスペースを追加 */
            }
            .truncate-lines {
                display: -webkit-box;
                -webkit-line-clamp: 2; /* 2行に制限 */
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
            /* スマートフォンで非表示にする項目 */
            td[data-label='成分名'],
            td[data-label='出荷量状況'] {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-200 p-4 sm:p-8 flex flex-col items-center min-h-screen">
    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg w-full max-w-7xl relative">
        <div class="flex justify-between items-center mb-6">
            <div class="flex-grow flex justify-center">
                <div class="bg-indigo-100 rounded-lg py-2 px-4 mb-4 text-center inline-block">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">
                        <span class="hidden sm:inline">医薬品 出荷状況検索ツール</span>
                        <span class="sm:hidden">医薬品 出荷状況</span>
                    </h2>
                </div>
            </div>
            <a href="https://nekoneko0404.github.io/search-for-medicine-test03/readme.html" target="_blank" class="text-indigo-600 hover:text-indigo-800 transition ease-in-out duration-150 font-medium whitespace-nowrap">
                使い方
            </a>
        </div>
        
        <div id="messageBox" class="text-sm sm:text-base text-center p-3 rounded-lg hidden message-box-center w-3/4"></div>
        
        <div class="search-form-grid mb-6">
            <div class="input-container">
                <label for="drugName" class="block text-gray-700 text-sm font-medium mb-1">医薬品名:</label>
                <input type="text" id="drugName" placeholder="例: ロキソニン" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition ease-in-out duration-150 p-2">
            </div>
            <div class="input-container">
                <label for="ingredientName" class="block text-gray-700 text-sm font-medium mb-1">成分名:</label>
                <input type="text" id="ingredientName" placeholder="例: ロキソプロフェン" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition ease-in-out duration-150 p-2">
            </div>
            <div class="input-container">
                <label for="makerName" class="block text-gray-700 text-sm font-medium mb-1">規格、剤形、ﾒｰｶｰ:</label>
                <input type="text" id="makerName" placeholder="例: 60mg" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition ease-in-out duration-150 p-2">
            </div>
            <div class="search-button-container flex items-end justify-center sm:justify-end">
                <button onclick="searchData()" class="w-full sm:w-auto bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-md shadow transition ease-in-out duration-150">検索</button>
            </div>
        </div>
        
        <div class="table-container rounded-lg shadow-md border border-gray-200">
            <table id="resultTable" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-indigo-100 sticky top-0">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap lg:w-[30%]">品名</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap lg:w-[30%]">成分名</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap lg:w-[8%]">
                            <div class="flex items-center">
                                <span>出荷状況</span>
                                <button onclick="sortResults('status')" class="ml-1 text-indigo-600 hover:text-indigo-800 transition-colors duration-150">
                                    <span id="sort-status-icon">▲</span>
                                </button>
                            </div>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap lg:w-[22%]">制限理由</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap lg:w-[10%]">出荷量状況</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="resultTableBody">
                    </tbody>
            </table>
        </div>
        
        <div class="mt-8 text-center text-gray-500 text-sm">
            <p>ご意見・ご要望は製作者までお寄せください。</p>
            <p>ツイッター: <a href="https://x.com/oshigoto_twitte" target="_blank" class="text-indigo-500 hover:underline">@oshigoto_twitte</a></p>
        </div>
    </div>

    <script>
        let excelData = [];
        let filteredResults = []; // 検索結果を格納する配列
        let sortStates = { // ソートの状態を管理
            status: 'asc'
        };
        const messageBox = document.getElementById('messageBox');
        
        // メッセージを表示する関数
        function showMessage(text, type = 'info') {
            messageBox.textContent = text;
            messageBox.classList.remove('hidden', 'bg-red-200', 'text-red-800', 'bg-green-200', 'text-green-800', 'bg-blue-200', 'text-blue-800');
            messageBox.classList.add('block');
            if (type === 'error') {
                messageBox.classList.add('bg-red-200', 'text-red-800');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-200', 'text-green-800');
            } else {
                messageBox.classList.add('bg-blue-200', 'text-blue-800');
            }
        }
        
        // 指定時間後にメッセージを非表示にする関数
        function hideMessage(delay) {
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, delay);
        }

        // 半角・全角、ひらがな・カタカナ、大文字・小文字を区別せず統一する関数
        function normalizeString(str) {
            if (!str) return '';
            // ① ひらがなをカタカナに変換
            const hiraToKata = str.replace(/[\u3041-\u3096]/g, function(match) {
                const charCode = match.charCodeAt(0) + 0x60;
                return String.fromCharCode(charCode);
            });
            // ② Unicode正規化(NFKC)で全角英数字・記号を半角に統一
            const normalizedStr = hiraToKata.normalize('NFKC');
            // ③ 全てを小文字に変換
            return normalizedStr.toLowerCase();
        }
        
        // スペース区切りのキーワードを正規化して配列に分割する
        function getSearchKeywords(input) {
            // 全角・半角スペースで分割し、空文字列をフィルタリング
            return input.split(/\s+|　+/).filter(keyword => keyword !== '').map(keyword => normalizeString(keyword));
        }

        // Excelデータを処理する共通関数
        function processExcelData(data) {
            try {
                const workbook = XLSX.read(data, {type: 'array'});
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                excelData = XLSX.utils.sheet_to_json(sheet, {header:1});
                showMessage("データの読み込みが完了しました。", "success");
                hideMessage(3000);
            } catch (error) {
                console.error('Error processing data:', error);
                showMessage("データの処理中にエラーが発生しました。", "error");
                hideMessage(3000);
            }
        }

        // 検索ボタンクリック時の処理
        function searchData() {
            if (excelData.length === 0) {
                showMessage("先にデータを読み込んでください。", "error");
                hideMessage(3000);
                return;
            }

            // 検索キーワードをスペースで分割して正規化
            const drugKeywords = getSearchKeywords(document.getElementById('drugName').value);
            const ingredientKeywords = getSearchKeywords(document.getElementById('ingredientName').value);
            const makerKeywords = getSearchKeywords(document.getElementById('makerName').value);

            filteredResults = []; // 新しい検索結果を格納
            
            // ヘッダー行をスキップして検索
            for (let i = 1; i < excelData.length; i++) {
                const row = excelData[i];
                if (!row || row.length < 17) continue;

                // データの文字列も正規化
                const drugName = normalizeString(row[5] || "");      // F列: 品名
                const ingredientName = normalizeString(row[2] || ""); // C列: 成分名
                const makerName = normalizeString((row[6] || "") + (row[9] || "")); // G列とJ列を結合

                // すべてのキーワードが一致するかチェック（AND検索）
                const matchDrug = drugKeywords.every(keyword => drugName.includes(keyword));
                const matchIngredient = ingredientKeywords.every(keyword => ingredientName.includes(keyword));
                // 品名、規格、剤形、ﾒｰｶｰ名に対してmakerNameを検索
                const matchMaker = makerKeywords.every(keyword => drugName.includes(keyword) || makerName.includes(keyword));
                
                if (matchDrug && matchIngredient && matchMaker) {
                    filteredResults.push(row);
                }
            }

            if (filteredResults.length === 0) {
                renderTable(filteredResults);
                showMessage("検索結果が見つかりませんでした。", "info");
                hideMessage(3000);
                return;
            }
            
            // 初期ソート状態をリセット
            sortStates.status = 'asc';
            document.getElementById('sort-status-icon').textContent = '▲';

            renderTable(filteredResults);

            if (filteredResults.length > 500) {
                showMessage(`${filteredResults.length} 件のデータが見つかりました。\n表示は上位 500 件に制限されています。`, "success");
            } else {
                showMessage(`${filteredResults.length} 件のデータが見つかりました。`, "success");
            }
            hideMessage(3000);
        }

        // 成分名クリック時の処理を追加
        function handleIngredientClick(ingredient) {
            // すべての検索欄をクリア
            document.getElementById('drugName').value = '';
            document.getElementById('makerName').value = '';
            
            // 成分名に頭から5文字を入力
            const searchIngredient = ingredient.length > 5 ? ingredient.substring(0, 5) : ingredient;
            document.getElementById('ingredientName').value = searchIngredient;

            // 検索を実行
            searchData();
            showMessage(`「${searchIngredient}」で再検索を実行しました。`, 'info');
            hideMessage(3000);
        }

        // テーブルをレンダリングする関数
        function renderTable(data) {
            const resultBody = document.getElementById('resultTableBody');
            resultBody.innerHTML = "";

            if (data.length === 0) {
                const row = resultBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 5; 
                cell.textContent = "該当データがありません";
                cell.className = "px-4 py-3 text-sm text-gray-500 text-center italic";
                return;
            }

            const displayResults = data.slice(0, 500);
            displayResults.forEach((row, index) => {
                const newRow = resultBody.insertRow();
                // 行のインデックスに基づいて背景色を交互に設定
                const rowBgClass = index % 2 === 1 ? 'bg-indigo-50' : 'bg-white';
                newRow.className = `${rowBgClass} transition-colors duration-150 hover:bg-indigo-200`;

                // 品名 (PMDAの検索ページにリンクとラベル)
                const drugNameCell = newRow.insertCell(0);
                drugNameCell.setAttribute('data-label', '品名');
                drugNameCell.classList.add("px-4", "py-3", "text-sm", "text-gray-900");
                
                let labelsHtml = '';
                const hColumnValue = (row[7] || '').trim(); // H列: 後発品・長期収載品
                const iColumnValue = (row[8] || '').trim(); // I列: 基礎的医薬品

                const labels = [];
                if (hColumnValue === '後発品') {
                    labels.push(`<span class="bg-green-200 text-green-800 px-1 rounded-sm text-xs font-bold">後</span>`);
                }
                if (iColumnValue === '基礎的医薬品') {
                    labels.push(`<span class="bg-purple-200 text-purple-800 px-1 rounded-sm text-xs font-bold">基</span>`);
                }
                
                if (labels.length > 0) {
                    labelsHtml = `<div class="flex flex-col space-y-1 mr-2">${labels.join('')}</div>`;
                }

                const drugName = row[5]; // F列
                const yjCode = row[4]; // E列
                const pmdaLinkUrl = `https://www.pmda.go.jp/PmdaSearch/rdSearch/02/${yjCode}?user=1`;
                
                // 品名のリンクにもtruncate-linesを適用
                drugNameCell.innerHTML = `<div class="flex items-start">${labelsHtml}<a href="${pmdaLinkUrl}" target="_blank" class="text-indigo-600 font-semibold hover:underline truncate-lines">${drugName || ""}</a></div>`;
                
                // 成分名
                const ingredientNameCell = newRow.insertCell(1);
                ingredientNameCell.setAttribute('data-label', '成分名');
                ingredientNameCell.classList.add("px-4", "py-3", "text-sm", "text-gray-900", "truncate-lines");
                const ingredientName = row[2] || "";
                // クリックイベントを追加
                if (ingredientName) {
                    // ここにハイパーリンクを適用
                    ingredientNameCell.innerHTML = `<a href="#" onclick="handleIngredientClick('${ingredientName.replace(/'/g, "\\'")}')" class="text-indigo-600 font-semibold hover:underline">${ingredientName}</a>`;
                } else {
                    ingredientNameCell.textContent = ingredientName;
                }
                
                // 出荷対応状況 (YJコード検索ページにリンクと色分け)
                const statusCell = newRow.insertCell(2);
                statusCell.setAttribute('data-label', '出荷状況');
                statusCell.classList.add("px-4", "py-3", "text-sm", "text-center", "font-medium", "rounded-md");
                const status = (row[11] || '').trim(); // L列が出荷対応状況
                
                // 色分けを適用
                let colorClass = 'text-gray-900';
                switch(status) {
                    case '後':
                        colorClass = 'bg-green-200 text-green-800';
                        break;
                    case '基':
                        colorClass = 'bg-purple-200 text-purple-800';
                        break;
                    default:
                        colorClass = 'text-gray-900';
                }
                statusCell.classList.add(colorClass);

                // YJコードがあればリンクを生成
                if (yjCode) {
                    const yjCodeLinkUrl = `https://nekoneko0404.github.io/search-for-medicine-test03/yjcode.html?yjcode=${yjCode}`;
                    statusCell.innerHTML = `<a href="${yjCodeLinkUrl}" target="_blank" class="w-full h-full block text-indigo-600 hover:underline">${status || ""}</a>`;
                } else {
                    statusCell.textContent = status || "";
                }
                
                const reasonCell = newRow.insertCell(3);
                reasonCell.textContent = row[13] || "";
                reasonCell.setAttribute('data-label', '制限理由');
                reasonCell.classList.add("px-4", "py-3", "text-sm", "text-gray-900");

                const volumeCell = newRow.insertCell(4);
                volumeCell.textContent = row[16] || "";
                volumeCell.setAttribute('data-label', '出荷量状況');
                volumeCell.classList.add("px-4", "py-3", "text-sm", "text-gray-900");
            });
        }

        // ソートを実行する関数
        function sortResults(key) {
            if (filteredResults.length === 0) {
                showMessage("ソートするデータがありません。", "info");
                hideMessage(3000);
                return;
            }

            // ソートの方向を反転
            const newDirection = sortStates[key] === 'asc' ? 'desc' : 'asc';
            sortStates[key] = newDirection;

            // ソートアイコンを更新
            document.getElementById(`sort-${key}-icon`).textContent = newDirection === 'asc' ? '▲' : '▼';
            
            // 出荷状況のソート
            filteredResults.sort((a, b) => {
                const aValue = (a[11] || '').trim(); // J列: 出荷対応状況
                const bValue = (b[11] || '').trim();
                
                // 日本語の文字列比較
                const compare = aValue.localeCompare(bValue, 'ja', { sensitivity: 'base' });
                return newDirection === 'asc' ? compare : -compare;
            });

            // テーブルを再レンダリング
            renderTable(filteredResults);
            showMessage(`「出荷状況」を${newDirection === 'asc' ? '昇順' : '降順'}でソートしました。`, "success");
            hideMessage(3000);
        }
        
        // エンターキーで検索をトリガーするイベントリスナー
        document.getElementById('drugName').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                searchData();
            }
        });
        document.getElementById('ingredientName').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                searchData();
            }
        });
        document.getElementById('makerName').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                searchData();
            }
        });
        
        // 日付をフォーマットする関数 (YYMMDD)
        function formatDate(date) {
            const year = date.getFullYear().toString().slice(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}${month}${day}`;
        }

        // アプリ起動時にGoogleスプレッドシートからデータを自動で読み込む
        window.onload = function() {
            // 新しいスプレッドシートのID
            const spreadsheetId = '1zdSaqw_cYDUOgufUREsoDUE_BxCrQmMd';
            // CSV形式でエクスポートするためのURL
            const exportUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=xlsx`;

            async function fetchSpreadsheetData() {
                showMessage('共有スプレッドシートからデータを読み込み中です...', 'info');
                
                try {
                    const response = await fetch(exportUrl);
                    if (response.ok) {
                        const data = await response.arrayBuffer();
                        processExcelData(new Uint8Array(data));

                        // 成功メッセージはprocessExcelDataで表示される
                    } else {
                        showMessage(`データの取得に失敗しました。ステータスコード: ${response.status}`, 'error');
                        hideMessage(5000);
                    }
                } catch (error) {
                    console.error('データの取得に失敗しました:', error);
                    showMessage('共有スプレッドシートからのデータの取得中にエラーが発生しました。', 'error');
                    hideMessage(5000);
                }
            }
            
            fetchSpreadsheetData();
        };
    </script>
</body>
</html>
